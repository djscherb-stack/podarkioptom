# Загрузка отчётов из 1С через Mailparser

> **Альтернатива (Zapier + Gmail):** [EMAIL_UPLOAD.md](EMAIL_UPLOAD.md)

Схема: **1С → письмо на Mailparser → webhook → наш сайт**

Mailparser принимает письма с вложениями, извлекает данные из Excel и отправляет их на наш webhook.

---

## Шаг 1. Регистрация в Mailparser

1. Откройте [mailparser.io](https://mailparser.io)
2. Зарегистрируйтесь или войдите
3. Используйте пробный период (30 дней бесплатно)

---

## Шаг 2. Создание Inbox

1. В панели Mailparser нажмите **Add Inbox** (Добавить ящик)
2. Укажите имя, например: «Аналитика выпуска»
3. Скопируйте адрес ящика — он будет вида `xxx@inbound.mailparser.io` или `xxx@mailparser.io`

Этот адрес — куда нужно отправлять письма из 1С.

---

## Шаг 3. Настройка парсинга вложений

1. Откройте созданный Inbox
2. Перейдите в **Parsing Rules** (Правила парсинга)
3. Нажмите **Create Rule** (Создать правило)

### Вариант A: извлечь всю таблицу (предпочтительно)

Создайте **6 правил** — по одному на каждую колонку Excel. В каждом правиле:

| Имя поля (Field Name) | Источник | Описание |
|----------------------|----------|----------|
| `Артикул` | Attachment → Table Cells | Артикул продукции |
| `Вид номенклатуры` | Attachment → Table Cells | Вид номенклатуры |
| `Наименование` | Attachment → Table Cells | Наименование продукции |
| `Количество` | Attachment → Table Cells | Количество выпущено |
| `Дата` | Attachment → Table Cells | Дата выпуска |
| `Подразделение` | Attachment → Table Cells | Подразделение |

Для каждого правила:

1. **Data source:** Attachment  
2. **Filter type:** Table Cells (для Excel)  
3. Выберите область таблицы в превью  
4. **Field name:** укажите точно, как в таблице выше (с учётом регистра)

### Вариант B: одно правило на всю таблицу

Если Mailparser позволяет извлечь всю таблицу одним правилом:

1. Создайте одно правило с источником **Attachment → Table Cells**
2. Выберите всю область данных (все строки и столбцы)
3. Имена полей в webhook должны соответствовать: Артикул, Вид номенклатуры, Наименование, Количество, Дата, Подразделение

### Тестовое письмо

1. Отправьте из 1С (или вручную) тестовое письмо с Excel-вложением на адрес Inbox
2. В Mailparser вкладка **Parsed Emails** — проверьте, что данные извлекаются корректно

---

## Шаг 4. Настройка Webhook

1. В Inbox откройте **Integrations** или **Downloads & API**
2. Найдите **Webhook** (HTTP Webhook)
3. Нажмите **Add Webhook** или **Configure**

### Параметры webhook

- **URL:**
  ```
  https://podarkioptom.onrender.com/api/upload-from-mailparser
  ```
- **Method:** POST
- **Content-Type:** application/json

### Заголовки (Headers)

Добавьте заголовок для авторизации:

| Key | Value |
|-----|-------|
| `X-Upload-Token` | ваш UPLOAD_TOKEN (из Render Environment) |

(Тот же токен, что используется для `/api/upload-by-token`.)

### Формат данных

- Выберите **JSON**
- Убедитесь, что в запрос попадает объект `parsed_data` с полями: Артикул, Вид номенклатуры, Наименование, Количество, Дата, Подразделение

### Сохранение

Нажмите **Save** / **Activate**.

---

## Шаг 5. Настройка 1С

1. В 1С настройте отправку почты (SMTP)
2. Адрес получателя — адрес Inbox Mailparser (из шага 2)
3. В письме — вложение Excel с отчётом выпуска

Структура Excel (6 колонок):

1. Артикул  
2. Вид номенклатуры  
3. Наименование продукции  
4. Количество  
5. Дата выпуска  
6. Подразделение  

---

## Шаг 6. Проверка

1. Отправьте из 1С письмо с Excel-вложением
2. В Mailparser проверьте, что письмо обработано (Parsed Emails)
3. Откройте сайт аналитики и убедитесь, что данные обновились

---

## Устранение неполадок

### Webhook не срабатывает

- Убедитесь, что URL правильный и сайт доступен
- Проверьте, что `X-Upload-Token` указан и совпадает с `UPLOAD_TOKEN` в Render
- В логах Mailparser посмотрите ответ сервера (ошибки 403, 400 и т.д.)

### Данные не появляются на сайте

- Убедитесь, что имена полей в правилах парсинга совпадают с ожидаемыми: Артикул, Вид номенклатуры, Наименование, Количество, Дата, Подразделение
- Проверьте формат даты (должен быть читаемым: `dd.mm.yyyy` или `yyyy-mm-dd`)
- Посмотрите ответ webhook в Mailparser — при ошибке сервер вернёт описание

### Поддерживаемые форматы webhook

Наш endpoint принимает JSON в формате Mailparser:

- `parsed_data` — объект с полями (массивы по колонкам или одна строка)
- или `data` / `rows` — массив объектов-строк
- Поддерживаются варианты имён: Артикул / article, Вид номенклатуры / nomenclature_type и т.д.
