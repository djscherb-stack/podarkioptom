# Выгрузка в интернет: код + данные за январь и февраль, проверка синхронизации с Google

Пошаговая инструкция: выложить код, чтобы на сервере уже были данные за январь и февраль, и убедиться, что завтра синхронизация с Google Drive подтянет новые данные и дополнит таблицы.

---

## 1. Выгрузить код в интернет

1. Закоммитьте и запушьте все изменения в репозиторий (GitHub):

   ```bash
   cd /Users/dmitriy/ProAnalitik
   git status
   git add .
   git commit -m "Деплой: аналитика разборки, проверка стоимости, синхронизация с Google"
   git push origin main
   ```

2. На [Render](https://dashboard.render.com) откройте ваш сервис **proanalitik** (или как он назван).
3. Если включён **Auto-Deploy** — деплой запустится сам после `git push`. Иначе: **Manual Deploy** → **Deploy latest commit**.
4. Дождитесь окончания сборки и запуска (в логах не должно быть ошибок).

---

## 2. Данные за январь и февраль уже в интернете

Папка `data/` в репозитории не коммитится (она в `.gitignore`), поэтому Excel-файлы с вашего компьютера сами по себе на сервер не попадут. Чтобы таблицы на сайте сразу показывали данные за январь и февраль, нужно один раз «залить» эти данные на сервер. Два варианта.

### Вариант A: Через Google Drive (рекомендуется)

1. В папке Google Drive, которую использует проект, должны лежать Excel-файлы за январь и февраль:
   - выпуск продукции (имена вида «Выпуск продукции …»);
   - выработка сотрудников («Выработка сотрудников …»);
   - разборка возвратов: файлы с префиксами **001**, **002**, **003**, **004** (внутреннее потребление, перемещение готовой продукции, поступление возвратов, поступление ингредиентов после разборки).
2. Убедитесь, что в Render заданы переменные:
   - `GOOGLE_DRIVE_FOLDER_ID` — ID этой папки;
   - `GOOGLE_DRIVE_CREDENTIALS_JSON` — JSON ключа сервисного аккаунта;
   - `UPLOAD_TOKEN` — секретный токен для вызова синхронизации.
3. Один раз запустите синхронизацию вручную (подставьте свой URL и токен):

   ```bash
   curl -s -H "X-Upload-Token: ВАШ_UPLOAD_TOKEN" "https://proanalitik.onrender.com/api/sync-from-gdrive"
   ```

   В ответе будет `"ok": true` и список `downloaded` — какие файлы скачаны. После этого данные за январь и февраль появятся на сервере и отобразятся в таблицах.

### Вариант B: Загрузка файлов по API с компьютера

Если файлы за январь и февраль есть только локально в папке `data/`:

```bash
# Подставьте свой URL и UPLOAD_TOKEN
BASE="https://proanalitik.onrender.com"
TOKEN="ВАШ_UPLOAD_TOKEN"

# Пример: загрузить один файл разборки
curl -X POST -H "X-Upload-Token: $TOKEN" -F "file=@data/004 поступление ингридиентов после разборки 2.xlsx" "$BASE/api/upload-by-token"

# Повторите для остальных файлов (001, 002, 003, выпуск продукции, выработка сотрудников и т.д.)
```

После загрузки откройте сайт и проверьте страницы «По дню», «Разборка возвратов» — должны быть данные за январь и февраль.

---

## 3. Проверить, что синхронизация с Google работает

1. Вызовите синхронизацию ещё раз (например, после того как в Google Drive что-то обновили или добавили новый файл):

   ```bash
   curl -s -H "X-Upload-Token: ВАШ_UPLOAD_TOKEN" "https://proanalitik.onrender.com/api/sync-from-gdrive"
   ```

2. В ответе не должно быть `"ok": false` и текста ошибки. Если `"ok": true` и `downloaded` пустой — значит новых файлов не было (это нормально, если вы только что всё подтянули).
3. Зайдите на сайт под своим логином, откройте «Разборка возвратов», «Проверка стоимости», «По дню» — таблицы должны показывать данные за январь и февраль.

Если при вызове sync приходит ошибка про `GOOGLE_DRIVE_FOLDER_ID` или `GOOGLE_DRIVE_CREDENTIALS_JSON` — проверьте переменные окружения в Render (Environment). Если ошибка про доступ — проверьте, что папку в Google Drive расшарили на email сервисного аккаунта (см. [GOOGLE_DRIVE_SYNC.md](GOOGLE_DRIVE_SYNC.md)).

---

## 4. Чтобы завтра данные подтягивались и дополняли таблицу

Синхронизация должна вызываться каждый день (например, в 8–10 утра по Москве). Тогда новые файлы из Google Drive будут скачиваться на сервер и после перезагрузки данных таблицы будут дополняться.

### Настройка ежедневного вызова

**Способ 1: cron-job.org (подходит для бесплатного Render)**

1. Зарегистрируйтесь на [cron-job.org](https://cron-job.org).
2. **Create Cronjob**:
   - **URL:** `https://proanalitik.onrender.com/api/sync-from-gdrive`
   - **Request method:** GET
   - **Request headers:** `X-Upload-Token: ВАШ_UPLOAD_TOKEN`
3. **Schedule** → **Daily** → например 08:00, таймзона **Europe/Moscow**.
4. Сохраните.

**Способ 2: Render Cron Job** (если у вас есть Cron Job на Render)

- Команда:  
  `curl -s -H "X-Upload-Token: ВАШ_UPLOAD_TOKEN" https://proanalitik.onrender.com/api/sync-from-gdrive`
- Расписание: `0 5 * * *` (каждый день в 5:00 UTC = 8:00 МСК).

После этого завтра в заданное время cron вызовет `/api/sync-from-gdrive`. Сервер скачает из Google Drive только **новые или изменённые** файлы (по `modifiedTime`), сохранит их в папку данных и перезагрузит кэш. Таблицы (разборка, выпуск, выработка) автоматически дополнятся новыми данными.

---

## 5. Краткий чеклист

- [ ] Код запушен в GitHub (`git push origin main`).
- [ ] На Render выполнен деплой (авто или Manual Deploy).
- [ ] В Render заданы: `GOOGLE_DRIVE_FOLDER_ID`, `GOOGLE_DRIVE_CREDENTIALS_JSON`, `UPLOAD_TOKEN`.
- [ ] В папке Google Drive лежат файлы за январь и февраль (или файлы загружены по API).
- [ ] Один раз вызван sync:  
  `curl -H "X-Upload-Token: ..." https://proanalitik.onrender.com/api/sync-from-gdrive`
- [ ] На сайте проверены таблицы (разборка, по дню) — видны данные за январь и февраль.
- [ ] Настроен ежедневный cron (cron-job.org или Render Cron) на `/api/sync-from-gdrive`.

После этого код и данные за январь и февраль будут в интернете, синхронизация с Google — проверена, а завтра новые данные из Drive подтянутся и дополнят таблицы.
