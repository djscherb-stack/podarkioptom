# Автозагрузка Excel по API (с токеном)

Для автоматической выгрузки аналитики без входа в систему используйте endpoint с токеном.

**Для приёма из Mailparser** (при пересылке вложений письмом): см. [MAILPARSER_UPLOAD.md](MAILPARSER_UPLOAD.md) — endpoint `/api/upload-from-mailparser` принимает JSON.

## 1. Настройка токена

Задайте переменную окружения `UPLOAD_TOKEN` (например, на Render: Environment → Add Environment Variable):

```
UPLOAD_TOKEN=ваш_секретный_токен_123
```

Придумайте длинный случайный токен и никому его не передавайте.

---

## 2. Примеры запросов

### cURL (терминал / скрипт)

```bash
curl -X POST \
  -H "X-Upload-Token: ваш_секретный_токен_123" \
  -F "file=@путь/к/файлу.xlsx" \
  https://podarkioptom.onrender.com/api/upload-by-token
```

### PowerShell (Windows)

```powershell
$token = "ваш_секретный_токен_123"
$url = "https://podarkioptom.onrender.com/api/upload-by-token"
$file = "C:\путь\к\Выпуск продукции.xlsx"

Invoke-RestMethod -Uri $url -Method Post `
  -Headers @{"X-Upload-Token"=$token} `
  -Form @{file=Get-Item $file}
```

### Python

```python
import requests

url = "https://podarkioptom.onrender.com/api/upload-by-token"
token = "ваш_секретный_токен_123"
file_path = "Выпуск продукции.xlsx"

with open(file_path, "rb") as f:
    r = requests.post(
        url,
        headers={"X-Upload-Token": token},
        files={"file": (file_path, f, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")}
    )
print(r.json())
```

### 1С:ERP 2.5 (внешняя обработка или регламентное задание)

Создайте общую процедуру и вызовите её из обработки или регламентного задания:

```bsl
// Параметры:
//  ПутьКФайлу     — Строка, полный путь к Excel (например: "C:\Выгрузки\Выпуск продукции.xlsx")
//  URLСервера     — Строка (например: "https://podarkioptom.onrender.com")
//  ТокенЗагрузки  — Строка, значение UPLOAD_TOKEN
//
Функция ОтправитьОтчетНаАналитику(ПутьКФайлу, URLСервера, ТокенЗагрузки) Экспорт
    ИмяФайла = "";
    Попытка
        Файл = Новый Файл(ПутьКФайлу);
        ИмяФайла = Файл.Имя;
        Если Не Файл.Существует() Тогда
            Возврат "Файл не найден: " + ПутьКФайлу;
        КонецЕсли;
    Исключение
        Возврат "Ошибка: " + ОписаниеОшибки();
    КонецПопытки;
    
    ДвоичныеДанныеФайла = Новый ДвоичныеДанные(ПутьКФайлу);
    
    Разделитель = СтрЗаменить(Строка(Новый УникальныйИдентификатор), "-", "");
    ТипКонтента = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
    
    ЗаголовокЧасти = "--" + Разделитель + Символы.ПС +
        "Content-Disposition: form-data; name=""file""; filename=""" + ИмяФайла + """" + Символы.ПС +
        "Content-Type: " + ТипКонтента + Символы.ПС + Символы.ПС;
    
    КонецЧасти = Символы.ПС + "--" + Разделитель + "--" + Символы.ПС;
    
    ДвоичныеДанныеЗаголовка = ПолучитьДвоичныеДанныеИзСтроки(ЗаголовокЧасти, КодировкаТекста.UTF8);
    ДвоичныеДанныеКонца = ПолучитьДвоичныеДанныеИзСтроки(КонецЧасти, КодировкаТекста.UTF8);
    
    ТелоЗапроса = ДвоичныеДанныеЗаголовка.Соединить(ДвоичныеДанныеФайла).Соединить(ДвоичныеДанныеКонца);
    
    СтрокаURL = URLСервера;
    СтрокаURL = СтрЗаменить(СтрокаURL, " ", "");
    Если Не СтрЗаканчиваетсяНа(СтрокаURL, "/") Тогда
        СтрокаURL = СтрокаURL + "/";
    КонецЕсли;
    СтрокаURL = СтрокаURL + "api/upload-by-token";
    
    // Разбор URL: https://host/path -> Хост, Путь
    ПозицияПротокол = СтрНайти(СтрокаURL, "://");
    Если ПозицияПротокол = 0 Тогда
        Возврат "Неверный URL (нужен https://): " + СтрокаURL;
    КонецЕсли;
    ОстатокURL = Сред(СтрокаURL, ПозицияПротокол + 3);
    ПозицияСлэш = СтрНайти(ОстатокURL, "/");
    Если ПозицияСлэш > 0 Тогда
        Хост = Лев(ОстатокURL, ПозицияСлэш - 1);
        Путь = Сред(ОстатокURL, ПозицияСлэш);
    Иначе
        Хост = ОстатокURL;
        Путь = "/api/upload-by-token";
    КонецЕсли;
    
    Запрос = Новый HTTPЗапрос(Путь, ТелоЗапроса);
    Запрос.Заголовки.Вставить("Content-Type", "multipart/form-data; boundary=" + Разделитель);
    Запрос.Заголовки.Вставить("X-Upload-Token", ТокенЗагрузки);
    Запрос.Метод = "POST";
    
    Соединение = Новый HTTPСоединение(Хост, 443, , , , 60, Истина);
    
    Попытка
        Ответ = Соединение.ОтправитьДляОбработки(Запрос);
        Если Ответ.КодСостояния = 200 Тогда
            Возврат "OK: " + Ответ.ПолучитьТелоКакСтроку();
        Иначе
            Возврат "Ошибка " + Ответ.КодСостояния + ": " + Ответ.ПолучитьТелоКакСтроку();
        КонецЕсли;
    Исключение
        Возврат "Ошибка соединения: " + ОписаниеОшибки();
    КонецПопытки;
КонецФункции

Функция ПолучитьДвоичныеДанныеИзСтроки(Строка, Кодировка)
    Запись = Новый ЗаписьВДвоичныеДанные;
    Запись.УстановитьКодировку(Кодировка);
    Запись.Записать(Строка);
    Возврат Запись.ЗакрытьИПолучитьДвоичныеДанные();
КонецФункции
```

**Пример вызова** (в консоли запросов или обработке):
```bsl
Результат = ОтправитьОтчетНаАналитику(
    "C:\Выгрузки\Выпуск продукции январь.xlsx",
    "https://podarkioptom.onrender.com",
    "ваш_секретный_токен_123"
);
Сообщить(Результат);
```

**Регламентное задание:** создайте обработку с этой логикой и добавьте регламентное задание, которое:
1. Формирует отчёт в Excel (стандартными средствами ERP)
2. Вызывает `ОтправитьОтчетНаАналитику()` с путём к созданному файлу

---

## 3. Ответы

**Успех (200):**
```json
{"status": "ok", "file": "upload_20260130_120000.xlsx"}
```

**Ошибка токена (403):**
```json
{"detail": "Неверный или отсутствующий токен"}
```

**Ошибка файла:**
```json
{"error": "Нужен файл Excel (.xlsx или .xls)"}
```
