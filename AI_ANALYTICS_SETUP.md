# Настройка ИИ-аналитики за день

Пошаговая инструкция, чтобы блок «ИИ-аналитика» на странице «По дню» заработал.

---

## 1. Получить API-ключ OpenAI

1. Зайдите на [platform.openai.com](https://platform.openai.com).
2. Войдите в аккаунт или зарегистрируйтесь.
3. Откройте **API keys** (в меню или в настройках биллинга).
4. Нажмите **Create new secret key**, скопируйте ключ (он начинается с `sk-...`).  
   Сохраните ключ в надёжное место — позже его нельзя будет посмотреть снова.

---

## 2. Добавить ключ в переменные окружения

### Локальный запуск (на своём компьютере)

1. В корне проекта откройте файл **`.env`** (если его нет — скопируйте из `.env.example` и переименуйте).
2. Добавьте или измените строку:
   ```env
   OPENAI_API_KEY=sk-ваш-ключ-сюда
   ```
3. Сохраните файл. Не коммитьте `.env` в git — в нём секреты.

При старте бэкенд сам подхватывает переменные из `.env` в корне проекта.

### Сервер (Render, VPS, Docker и т.п.)

Задайте переменную окружения **`OPENAI_API_KEY`** в настройках окружения (Environment) вашего сервиса, со значением вашего ключа. Файл `.env` на сервере можно не создавать, если переменные задаются в панели.

---

## 3. (Необязательно) Выбрать модель

По умолчанию используется **`gpt-4o-mini`** (быстро и дёшево). Чтобы использовать другую модель:

- В **`.env`** (локально):
  ```env
  OPENAI_MODEL=gpt-4o
  ```
- Или задайте переменную **`OPENAI_MODEL`** на сервере.

---

## 4. Перезапустить приложение

- **Локально:** остановите backend (Ctrl+C в терминале, где он запущен) и снова запустите, например:
  ```bash
  ./start-analytics.sh
  ```
  или:
  ```bash
  cd backend && uvicorn app:app --host 0.0.0.0 --port 8000
  ```
- **На сервере:** сделайте redeploy или перезапуск сервиса после добавления переменных.

---

## 5. Проверить в интерфейсе

1. Откройте приложение и перейдите на страницу **«По дню»**.
2. Выберите дату, за которую есть данные.
3. Прокрутите до блока **«ИИ-аналитика за день»**.
4. Нажмите **«Запустить ИИ-аналитику»**.

Если ключ подхвачен и API доступен, через несколько секунд появятся оценка выработки по производствам, тренды и вопросы для руководителей. Если ключ не задан или не подхватился, в блоке будет сообщение о необходимости настроить `OPENAI_API_KEY`.

---

## Частые проблемы

| Ситуация | Что сделать |
|----------|-------------|
| «OPENAI_API_KEY не задан» | Проверьте, что в `.env` есть строка `OPENAI_API_KEY=sk-...` без кавычек и пробелов вокруг `=`, и что backend перезапущен после изменения `.env`. |
| Ошибка 401 от OpenAI | Ключ неверный или отозван. Создайте новый ключ в кабинете OpenAI. |
| Ошибка доступа / таймаут | Проверьте интернет и (при необходимости) прокси/файрвол; для OpenAI нужен доступ в интернет. |
| На Render ключ не виден | В Dashboard → ваш сервис → Environment добавьте переменную `OPENAI_API_KEY` и сделайте redeploy. |

После выполнения этих шагов ИИ-аналитика должна заработать.
